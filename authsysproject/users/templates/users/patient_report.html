<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Report</title>
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        
        /* Navigation Bar Styles */
        .navbar {
            background-color: white;
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            border-bottom: 2px solid #ddd; 
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            gap: 15px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Form Styles */
        .input {
            border: none;
            border-bottom: 2px solid #3366cc;
            outline: none;
            font-size: 16px;
            width: 200px;
            padding: 5px;
            margin-bottom: 10px;
        }
        
        .input-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .gender-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .gender-group label {
            margin-right: 10px;
        }
        
        /* Content Area Styles */
        .content {
            padding: 20px;
            background: white;
            margin: 80px 20px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgb(222, 248, 254);
        }
        
        /* Modal Header Styles */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-primary {
            background-color: #3366cc;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        /* Form Layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table td, .table th {
            border: 1px solid #9c7373;
            height:40px;
            padding: 12px;
            text-align: center; /* Centers text */
            vertical-align: middle; /* Centers content vertically */
        }
        
        .table th {
            background-color: #f2f2f2;
        }
        
        /* Observation Section */
        .observation {
            margin-top: 20px;
        }
        
        /* Doctor Signature Section */
        .doctor-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 200px;
            width: 100%;
        }
        
        .doctor {
            text-align: center;
            margin: 10px; /* Reduced margin */
        }
        
        .doctor img {
            max-width: 400px; /* Ensures image is responsive */
            height: 100px;
            margin-bottom: 1px; /* Adjust space below the image */
        }
        
        .doctor p {
            margin: 2px 0; /* Minimize gaps between paragraphs */
        }
        
        .signature {
            height: 50px;
            margin-bottom: 5px;
        }
        
        /* Logout Button Styling */
        .login {
            background-color: #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .login a {
            color: white;
            text-decoration: none;
        }
        
        /* Checkbox Fieldset */
        fieldset {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        fieldset label {
            display: block;
            margin-bottom: 8px;
        }
        
        /* Image Styling */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
            border: 1px solid white;
        }
        
        /* Report Container */
        .report-container {
            margin-top: 20px;
            padding: 10px;
            border: 2px solid white;
            background-color: white;
        }
        
        /* Final Report Container */
        .final-report {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid white;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle visibility */
        .hidden {
            display: none;
        }

        .a4-size {
            width: 100%;
            max-width: 794px; /* A4 width in pixels at 96 DPI */
            height: auto; /* A4 height in pixels at 96 DPI */
            background: white;
            border: 1px solid white;
            margin: auto;
          }
          .border-container {
            border: 2px solid black; /* Border color */
            padding: 10px;
            display: inline-block;
        }  
          
        
        /* Print styles */
        @media print {
            .navbar, .modal-header, fieldset, .input-container, #ecgFindings, 
            #report-container, .btn, #viewSelect, #actionSelect, .login {
                display: none !important;
            }
            
            .final-report {
                display: block !important;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            body, .content, .final-report {
                background: white;
                margin: 0;
                padding: 0;
            }
        }

        .loader {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 1;
          width: 70px;
          height: 70px;
          margin: -25px 0 0 -25px;
          border: 10px solid transparent;
          border-radius: 50%;
          border-top-color: #3498db;
          -webkit-animation: spin 2s linear infinite;
          animation: spin 2s linear infinite;
          display: none; /* Initially hide the loader */
        }

        #notification {
          position: absolute;
          left: 50%;
          top: 50%;
          z-index: 2;
          background-color: #3498db;
          margin: -25px 0 0 -25px;
          border: 2px solid #2980b9;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
          display: none; /* Initially hide the loader */
          color: #ecf0f1;
          padding: 25px;
          text-align: center;
          font-family: 'Arial', sans-serif;
        }  
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <select id="viewSelect">
                <option value="reporting-bot">Reporting Bot</option>
                <option value="camp-ecg">CAMP ECG</option>
            </select>
            <select id="actionSelect" onchange="handleAction(this.value)" placeholder="Export">
                <option value="export" >Export</option>
                <option value="get-pdf">Get PDF</option>
                <option value="upload-pdf">Upload ECG PDF</option>
            </select>
        </div>
        <div class="nav-right">
            <div class="user-name">Welcome </div>
            <div class="login"><a href="/logout" class="report-here">Logout</a></div>
        </div>
    </nav>
    
    <!-- Reporting Bot View -->
    <div id="reporting-bot" class="content">
        <div class="loader"></div>
        <div id="notification">
          <p id="notification-text"></p>
        </div>
        <div><h2>Patient Report</h2>
            <img id="patientImage" src="" alt="Patient Image">
        </div>
        
        <!-- Final Report (initially hidden) -->
        <div id="finalReport" class="final-report hidden">
            <!-- Will be populated when Done is clicked -->
        </div>
    </div>

    <!-- Camp ECG View -->
    <div id="camp-ecg" class="content" style="display:none;">
        <div class="modal-header">
            <div><h2>Camp (ECG)</h2></div>
            <div>
                <button type="button" class="btn btn-secondary" id="backButton">Back</button>
                <button type="button" class="btn btn-primary" id="doneButton">Done</button>
                <button type="button" class="btn btn-danger" id="rejectButton">Reject</button>
            </div>    
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campPatientName">Name:</label>
                <input class="input" type="text" id="campPatientName">
            </div>
            <div class="input-container">
                <label for="campPatientId">Patient ID:</label>
                <input class="input" type="text" id="campPatientId">
            </div>
            <div class="input-container">
                <label for="campAge">Age:</label>
                <input class="input" type="text" id="campAge">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <label for="campTestDate">Test Date:</label>
                <input type="date" id="campTestDate" class="input">
            </div>
            <div class="input-container">
                <label for="campReportDate">Report Date:</label>
                <input type="date" id="campReportDate" class="input">
            </div>
            <div class="input-container">
                <label for="campHeartRate">Heart Rate:</label>
                <input class="input" type="text" id="campHeartRate">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-container">
                <div class="gender-group">
                    <label>Gender:</label>
                    <label><input type="radio" name="gender" value="male" checked> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="others"> Others</label>
                </div>
            </div>
        </div>
{% comment %}         
        <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="checkbox" id="normalECG" name="ecgFindings"> Normal ECG</label>
            <label><input type="checkbox" id="sinusRhythmRBBB" name="ecgFindings"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusTachycardiaRBBB" name="ecgFindings"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardiaRBBB" name="ecgFindings"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="checkbox" id="sinusBradycardia" name="ecgFindings"> Sinus Bradycardia</label>
            <label><input type="checkbox" id="sinusTachycardia" name="ecgFindings"> Sinus Tachycardia</label>
        </fieldset>
         {% endcomment %}
         <fieldset id="ecgFindings">
            <legend>ECG Findings</legend>
            <label><input type="radio" id="normalECG" name="ecgFindings" value="normalECG"> Normal ECG</label>
            <label><input type="radio" id="sinusRhythmRBBB" name="ecgFindings" value="sinusRhythmRBBB"> Sinus rhythm with incomplete RBBB</label>
            <label><input type="radio" id="sinusTachycardiaRBBB" name="ecgFindings" value="sinusTachycardiaRBBB"> Sinus Tachycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardiaRBBB" name="ecgFindings" value="sinusBradycardiaRBBB"> Sinus Bradycardia with incomplete RBBB</label>
            <label><input type="radio" id="sinusBradycardia" name="ecgFindings" value="sinusBradycardia"> Sinus Bradycardia</label>
            <label><input type="radio" id="sinusTachycardia" name="ecgFindings" value="sinusTachycardia"> Sinus Tachycardia</label>
        </fieldset>
        
        
        <div class="input-container">
            <label for="finding">Additional Findings:</label>
            <input type="text" id="finding" class="input">
        </div>
        
        <img id="ecgImage" src="" alt="ECG Graph">
        
        <!-- Generated Report Preview -->
        <div id="report-container" class="report-container">
            <!-- Report will be generated here -->
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <script>

        // // Initialize the page
        // window.onload = async function() {
        //     const data = getQueryParams();
            
        //     // Set up views
        //     document.getElementById('viewSelect').value = 'reporting-bot';
        //     document.getElementById('reporting-bot').style.display = 'block';
        //     document.getElementById('camp-ecg').style.display = 'none';
            
        //     // Load images
        //     const imgElements = [
        //         document.getElementById('patientImage'),
        //         document.getElementById('ecgImage')
        //     ].filter(Boolean);
        
        //     try {
        //         showLoader();
        //         const base64Img = await fetchImageAsBase64(data.reportImage);
        //         imgElements.forEach(img => {
        //             img.src = base64Img.startsWith('data:image') ? base64Img : data.reportImage;
        //         });
        //     } catch (error) {
        //         console.warn("Using original image URL");
        //         imgElements.forEach(img => img.src = data.reportImage);
        //     } finally {
        //         hideLoader();
        //         initializeEventListeners();
        //     }
        // };

        

        async function convertPresignedUrlToJpegDataUrl(presignedUrl) {
          return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous'; // Important for CORS
            
            img.onload = function() {
              try {
                // Create canvas to convert to JPEG
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                
                // Draw image to canvas
                ctx.drawImage(img, 0, 0);
                
                // Convert to JPEG data URL (quality 90%)
                const jpegDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                resolve(jpegDataUrl);
              } catch (error) {
                console.error('Canvas conversion failed:', error);
                resolve(presignedUrl); // Fallback to original URL
              }
            };
            
            img.onerror = function() {
              console.warn('Image load failed, using original URL');
              resolve(presignedUrl); // Fallback to original URL
            };
            
            // Add timestamp to bypass cache
            img.src = presignedUrl + (presignedUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
          });
        }
        
        // Usage in your window.onload
        window.onload = async function() {
          const data = getQueryParams();
          
          // Set up views
          document.getElementById('viewSelect').value = 'reporting-bot';
          document.getElementById('reporting-bot').style.display = 'block';
          document.getElementById('camp-ecg').style.display = 'none';
          
          // Get image elements
          const imgElements = [
            document.getElementById('patientImage'),
            document.getElementById('ecgImage')
          ].filter(Boolean);
        
          try {
            showLoader();
            
            // First set src to presigned URL directly
            imgElements.forEach(img => {
              img.src = data.reportImage;
            });
            
            // Then attempt conversion in background
            const jpegDataUrl = await convertPresignedUrlToJpegDataUrl(data.reportImage);
            
            if (jpegDataUrl.startsWith('data:image/jpeg')) {
              // Update images if conversion succeeded
              imgElements.forEach(img => {
                img.src = jpegDataUrl;
              });
            }
          } catch (error) {
            console.error('Image handling failed:', error);
          } finally {
            hideLoader();
            initializeEventListeners();
          }
        };



        // Set up event listeners
        function initializeEventListeners() {
            // View switcher
            document.getElementById('viewSelect').addEventListener('change', switchView);
            
            // Action handler
            document.getElementById('actionSelect').addEventListener('change', function() {
                handleAction(this.value);
                this.value = ''; // Reset selection
            });
            
            // Form inputs
            document.querySelectorAll('#camp-ecg input').forEach(input => {
                input.addEventListener('change', generateReport);
                input.addEventListener('input', generateReport);
            });
        }



        // Get URL parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            
            return {
                patientId: params.get('data-patientid') || '',
                patientName: decodeURIComponent(params.get('data-patientname') || ''),
                age: params.get('data-age') || '',
                gender: params.get('data-gender') || '',
                heartRate: params.get('data-heartrate') || '',
                prInterval: params.get('data-printerval') || '',
                testDate: params.get('data-testdate') || '',
                reportDate: params.get('data-reportdate') || '',
                reportImage: decodeURIComponent(params.get('data-reportimage') || ''),
                location: decodeURIComponent(params.get('data-location') || '')
            };
        }

        // Extract data from URL (alternative to getQueryParams)
        function extractDataFromURL() {
            return getQueryParams(); // Reuse the existing function
        }
        
        // Initialize form data object
        let formData = {
            normalECG: false,
            sinusRhythmRBBB: false,
            sinusTachycardiaRBBB: false,
            sinusBradycardiaRBBB: false,
            sinusBradycardia: false,
            sinusTachycardia: false,
            additionalFindings: ''
        };
        
        // Flag to track if report is finalized
        let isReportFinalized = true;
        
        function updateReportingBotView() {
            const data = getQueryParams();
            const patientImage = document.getElementById('patientImage');
            
            if (data.reportImage) {
                patientImage.src = data.reportImage;
            }
        }
        
        // Update Camp ECG View
        function updateCampEcgView() {
            const data = getQueryParams();
            
            // Update camp-ecg form inputs
            document.getElementById('campPatientName').value = data.patientName;
            document.getElementById('campPatientId').value = data.patientId;
            document.getElementById('campAge').value = data.age;
            document.getElementById('campHeartRate').value = data.heartRate;
            
            // Set test and report dates
            if (data.testDate) {
                document.getElementById('campTestDate').value = formatDateForInput(data.testDate);
            }
            
            if (data.reportDate) {
                document.getElementById('campReportDate').value = formatDateForInput(data.reportDate);
            }
            
            // Set gender radio buttons
            if (data.gender) {
                const genderRadio = document.querySelector(`input[name="gender"][value="${data.gender.toLowerCase()}"]`);
                if (genderRadio) {
                    genderRadio.checked = true;
                }
            }
            
            // Set ECG image
            document.getElementById('ecgImage').src = data.reportImage;
            
            // Generate initial report
            generateReport();
        }
        
        
        // Format date strings for HTML date inputs (YYYY-MM-DD)
        function formatDateForInput(dateString) {
            // If dateString is already in YYYY-MM-DD format, return as is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            // Try to parse the date
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return ''; // Return empty string if invalid date
            }
            
            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Generate and update the report
        
        function generateReport() {
            // Get current form values
            const name = document.getElementById('campPatientName').value;
            const patientId = document.getElementById('campPatientId').value;
            const age = document.getElementById('campAge').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Male';
            const testDate = document.getElementById('campTestDate').value;
            const reportDate = document.getElementById('campReportDate').value;
            const heartRate = document.getElementById('campHeartRate').value;
            
            // Get checkbox values
            formData.normalECG = document.getElementById('normalECG').checked;
            formData.sinusRhythmRBBB = document.getElementById('sinusRhythmRBBB').checked;
            formData.sinusTachycardiaRBBB = document.getElementById('sinusTachycardiaRBBB').checked;
            formData.sinusBradycardiaRBBB = document.getElementById('sinusBradycardiaRBBB').checked;
            formData.sinusBradycardia = document.getElementById('sinusBradycardia').checked;
            formData.sinusTachycardia = document.getElementById('sinusTachycardia').checked;
            formData.additionalFindings = document.getElementById('finding').value;
            
            // Format dates for display
            const displayTestDate = formatDateForDisplay(testDate);
            const displayReportDate = formatDateForDisplay(reportDate);
            let reportHTML = `
                <div id="editable-report" class="a4-size" contenteditable="true">
                    <div id="show">
                        <table id="table" class="table">
                            <tr>
                                <td><strong>Name:</strong> <strong>${name}</strong></td>
                                <td><strong>Patient ID:</strong> <strong>${patientId}</strong></td>
                                <td><strong>Age:</strong> <strong>${age}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Gender:</strong> <strong>${gender}</strong></td>
                                <td><strong>Test Date:</strong> <strong>${displayTestDate}</strong></td>
                                <td><strong>Report Date:</strong> <strong>${displayReportDate}</strong></td>
                            </tr>
                        </table>
                        <div class="observation">
                            <h3><strong>ECG</strong></h3>
                            <h4><strong>Observation:</strong></h4>
                            <ul>
                                <li><strong>Heart rate is ${heartRate} BPM.</strong></li>
            `;
            // Add findings with bold formatting
            if (formData.normalECG) {
                reportHTML += `<li><strong>Normal ECG.</strong></li>`;
            } else {
                if (formData.sinusRhythmRBBB) {
                    reportHTML += `<li><strong>Sinus rhythm with incomplete RBBB.</strong></li>`;
                }
                if (formData.sinusTachycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Tachycardia with incomplete RBBB.</strong></li>`;
                }
                if (formData.sinusBradycardiaRBBB) {
                    reportHTML += `<li><strong>Sinus Bradycardia with incomplete RBBB.</strong></li>`;
                }
                if (formData.sinusBradycardia) {
                    reportHTML += `<li><strong>Sinus Bradycardia.</strong></li>`;
                }
                if (formData.sinusTachycardia) {
                    reportHTML += `<li><strong>Sinus Tachycardia.</strong></li>`;
                }
            }
            
            // Add additional findings in bold
            if (formData.additionalFindings) {
                reportHTML += `<li><strong>${formData.additionalFindings}</strong></li>`;
            }
            
            // Add default finding if nothing is selected
            if (!formData.normalECG &&
                !formData.sinusRhythmRBBB &&
                !formData.sinusTachycardiaRBBB &&
                !formData.sinusBradycardiaRBBB &&
                !formData.sinusBradycardia &&
                !formData.sinusTachycardia &&
                !formData.additionalFindings) {
                reportHTML += `<li><strong>Normal Sinus Rhythm.</strong></li>`;
                reportHTML += `<li><strong>No significant ST-T changes seen.</strong></li>`;
            }
            
            reportHTML += `
                            </ul>
                        </div>
                        <div class="doctor-signature">
                            <div class="doctor">
                                <img src="{% static 'image/Signature1.png' %}" alt="Signature 1">
                                <p><strong>Dr. Arvind Dass</strong></p>
                                <p><strong>Principal Director</strong></p>
                                <p><strong>DM Cardiology</strong></p>
                            </div>
                            <div></div>
                            <div class="doctor">
                                <img src="{% static 'image/Signature2.png' %}" alt="Signature 2">
                                <p><strong>Dr. Nalin Singhal</strong></p>
                                <p><strong>Consultant</strong></p>
                                <p><strong>Non Invasive Cardiology</strong></p>
                            </div>  
                        </div>
                    </div>
            `;
            // Display ECG image
            if (document.getElementById('ecgImage').src) {
                reportHTML += `
                      <div id="ecgImage" class="ecg-image-container">
                          <img src="${document.getElementById('ecgImage').src}" alt="ECG Graph">
                      </div>
                    </div>  
                      
                `;
            }
            
            // Update report container
            document.getElementById('report-container').innerHTML = reportHTML;
            
            // Also update patient info in reporting-bot view
            document.getElementById('patientName').textContent = name;
            document.getElementById('patientId').textContent = patientId;
            document.getElementById('patientAge').textContent = age;
            document.getElementById('patientGender').textContent = gender;
            document.getElementById('patientHeartRate').textContent = heartRate;
            document.getElementById('patientTestDate').textContent = displayTestDate;
            document.getElementById('patientReportDate').textContent = displayReportDate;
            
            // If report is finalized, update final report as well
            if (isReportFinalized) {
                document.getElementById('finalReport').innerHTML = reportHTML;
            }
        }
        
        // Format date for display (e.g., "Jan 21, 2025")
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // Return original string if invalid date
            }
            
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        // Finalize report function - called when Done button is clicked
        function finalizeReport() {
            isReportFinalized = true;
            
            // Copy the current report to the final report container
            const reportHTML = document.getElementById('report-container').innerHTML;
            const finalReportContainer = document.getElementById('finalReport');
            //handleDone().catch(console.error);
            
            finalReportContainer.innerHTML = reportHTML;
            finalReportContainer.classList.remove('hidden');
            
            // Show final report in reporting-bot view
            document.getElementById('viewSelect').value = 'reporting-bot';
            document.getElementById('reporting-bot').style.display = 'block';
            document.getElementById('camp-ecg').style.display = 'none';
        }


        // Showing the notification on the browser.
        showNotification = (message) => {
            const notification = document.getElementById("notification");
            const notificationText = document.getElementById("notification-text");
      
            if (notification && notificationText) {
                notificationText.innerText = message;
                notification.style.display = "block";
      
                setTimeout(() => {
                    notification.style.display = "none";
                }, 1500);
            }
        };


        // Add this at the top level of your script
        function getCSRFToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue || '';
        }



        // Safe image fetching with CORS handling
        async function fetchImageAsBase64(imageUrl) {
            try {
                // Skip if already a data URL
                if (imageUrl.startsWith('data:image')) return imageUrl;
                
                // Use fetch with CORS mode
                const response = await fetch(imageUrl, {
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Image conversion failed:", error);
                return imageUrl; // Fallback to original URL
            }
        }


        showLoader = () => {
          console.log("Showing loader");
          const loader = document.querySelector(".loader");
          if (loader) {
              loader.style.display = "block";
          }
        };
      
        // This will hide the loader after report generation and doing respective task.
        hideLoader = () => {
          console.log("Hiding loader");
          const loader = document.querySelector(".loader");
          if (loader) {
              loader.style.display = "none";
          }
        };


        // Main PDF download function
        async function downloadPDF() {
            try {
                showLoader();
                
                // Get patient data
                const { patientId, patientName } = getQueryParams();
                const fileName = `${patientId}_${patientName}.pdf`.replace(/\s+/g, '_');
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "px",
                    format: "a4"
                });
        
                // Add ECG image
                const ecgImage = document.getElementById('ecgImage') || 
                                document.getElementById('patientImage');
                
                if (ecgImage && ecgImage.src) {
                    await addImageToPDF(pdf, ecgImage.src);
                }
        
                // Add report content
                const reportElement = document.getElementById('show');
                if (reportElement) {
                    const canvas = await html2canvas(reportElement, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        logging: true
                    });
                    pdf.addPage();
                    pdf.addImage(canvas, 'JPEG', 10, 10, pdf.internal.pageSize.width - 20, 0);
                }
        
                // Save and notify
                pdf.save(fileName);
                await handleDone();
                showNotification("PDF downloaded successfully!");
                
            } catch (error) {
                console.error("PDF generation failed:", error);
                showNotification("Error: " + error.message);
            } finally {
                hideLoader();
            }
        }
        
        // Helper function to add rotated image to PDF
        async function addImageToPDF(pdf, imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.height;
                    canvas.height = img.width;
                    const ctx = canvas.getContext('2d');
                    ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(90 * Math.PI/180);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    
                    pdf.addImage(canvas.toDataURL(), 'PNG', 20, 20, pdf.internal.pageSize.width - 40, 0);
                    resolve();
                };
                img.onerror = resolve; // Skip if image fails
                img.src = imageUrl;
            });
        }
        
        // Handle action select change
        function handleAction(action) {
            if (action === 'get-pdf') {
                downloadPDF();
            } else if (action === 'export') {
                handleAction();
            } else if (action === 'upload-pdf') {
                uploadEcgPDF();
            }
            
            // Reset select to default
            document.getElementById('actionSelect').value = '';
        }

        // Switch between views
        function switchView() {
            const reportingBot = document.getElementById('reporting-bot');
            const campEcg = document.getElementById('camp-ecg');
            const viewSelect = document.getElementById('viewSelect');
            
            if (viewSelect.value === 'reporting-bot') {
                reportingBot.style.display = 'block';
                campEcg.style.display = 'none';
                updateReportingBotView();
            } else {
                reportingBot.style.display = 'none';
                campEcg.style.display = 'block';
                updateCampEcgView();
            }
        }
        
        // Initialize event listeners
        function initializeEventListeners() {
            // View selector
            document.getElementById('viewSelect').addEventListener('change', switchView);
            
            // Form inputs
            document.querySelectorAll('#camp-ecg input').forEach(input => {
                input.addEventListener('change', generateReport);
                input.addEventListener('input', generateReport);
            });
            
            // ECG Findings checkboxes special handling - sync with form data
            document.querySelectorAll('input[name="ecgFindings"]').forEach(checkbox => {
                checkbox.addEventListener('change', generateReport);
            });
            
            // Button handlers
            document.getElementById('doneButton').addEventListener('click', finalizeReport);
            
            document.getElementById('rejectButton').addEventListener('click', function() {
                handleReject().catch(console.error);
                // Here you would typically handle the rejection logic
            });
            
            document.getElementById('backButton').addEventListener('click', function() {
                document.getElementById('viewSelect').value = 'reporting-bot';
                switchView();
            });
        }

        async function handleReject(event) {
            if (event) event.preventDefault(); // Prevent unintended redirection if event exists
        
            const urlSearchParams = new URLSearchParams(window.location.search);
            const patientId = urlSearchParams.get("data-patientid");
        
            if (!patientId) {
                console.error("Patient ID not found in URL.");
                return;
            }
        
            console.log("Rejecting patient with ID:", patientId);
        
            function getCSRFToken() {
                const match = document.cookie.match(/csrftoken=([\w-]+)/);
                return match ? match[1] : null;
            }
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                const response = await fetch(`/api/reject_patient_status/${patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ status: true }),
                });
        
                if (response.ok) {
                    console.log("Patient report rejected successfully.");
        
                    // Remove the rejected report from the dashboard
                    const reportElement = document.querySelector(`[data-patientid="${patientId}"]`);
                    if (reportElement) {
                        reportElement.remove();
                    }
        
                    // Delay redirection slightly to ensure the removal is visible
                    setTimeout(() => {
                        window.location.href = "/ecgallocation";
                    }, 500);
                } else {
                    console.error("Failed to update patient status.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
        async function handleDone() {
            // Get the patient ID from URL parameters
            const urlSearchParams = new URLSearchParams(window.location.search);
            const patientId = urlSearchParams.get("data-patientid");
        
            if (!patientId) {
                console.error("Patient ID not found in URL.");
                return;
            }
        
            // Get the CSRF token from cookies
            function getCSRFToken() {
                const match = document.cookie.match(/csrftoken=([\w-]+)/);
                return match ? match[1] : null;
            }
        
            const csrftoken = getCSRFToken();
            if (!csrftoken) {
                console.error("CSRF token not found.");
                return;
            }
        
            try {
                const response = await fetch(`/api/update_patient_done_status/${patientId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                    },
                    body: JSON.stringify({ isDone: true }),
                });
                console.log("Response:", response);
        
                /*if (response.ok) {
                    // Navigate back to refresh data
                    window.location.href = document.referrer + "?nocache=" + Date.now();
                } else {
                    console.error("Failed to update isDone status");
                }*/
            } catch (error) {
                console.error("Error:", error);
            }
        }





        async function uploadEcgPDF() {
            // Show loading indicator
            showLoader();
            
            try {
                // 1. Get patient data from URL parameters
                const params = new URLSearchParams(window.location.search);
                const patientId = params.get('data-patientid');
                const patientName = params.get('data-patientname');
                const testDate = params.get('data-testdate');
                const reportDate = params.get('data-reportdate');
                const location = params.get('data-location');
                
                if (!patientId || !patientName) {
                    throw new Error('Missing patient information');
                }
        
                // 2. Generate the PDF filename
                const filename = `${patientId.replace(/\s+/g, '_')}_${patientName.replace(/\s+/g, '_')}.pdf`;
        
                // 3. Create PDF document
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "px",
                    format: "a4"
                });
        
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
        
                // 4. Add ECG Image (rotated)
                const ecgImageElement = document.getElementById('ecgImage') || document.getElementById('patientImage');
                if (ecgImageElement && ecgImageElement.src) {
                    await addImageToPDF(pdf, ecgImageElement.src);
                } else {
                    console.warn('No ECG image found to include in PDF');
                }
        
                // 5. Add Report Content
                const reportElement = document.getElementById('show');
                if (reportElement) {
                    const canvas = await html2canvas(reportElement, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        logging: true
                    });
                    pdf.addPage();
                    pdf.addImage(canvas, 'JPEG', 10, 10, pageWidth - 20, 0);
                }
        
                // 6. Convert PDF to Blob
                const pdfBlob = pdf.output('blob');
        
                // 7. Prepare FormData for upload
                const formData = new FormData();
                formData.append('pdf', pdfBlob, filename);
                formData.append('patientId', patientId);
                formData.append('patientName', patientName);
                formData.append('testDate', testDate || '');
                formData.append('reportDate', reportDate || '');
                formData.append('location', location || '');
        
                // 8. Get CSRF Token
                function getCSRFToken() {
                    const cookieValue = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='))
                        ?.split('=')[1];
                    return cookieValue || '';
                }
        
                // 9. Upload to Server
                const response = await fetch('/upload_ecg_pdf/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                });
        
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Server returned ${response.status}`);
                }
        
                // 10. Update patient status
                await handleDone();
                
                // 11. Show success and redirect
                showNotification('PDF successfully uploaded!');
                setTimeout(() => {
                    window.location.href = document.referrer || '/ecgallocation';
                }, 2000);
        
            } catch (error) {
                console.error('PDF upload failed:', error);
                showNotification(`Upload failed: ${error.message}`);
            } finally {
                hideLoader();
            }
        }
        
        // Helper function to add rotated image to PDF
        async function addImageToPDF(pdf, imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                
                img.onload = function() {
                    try {
                        // Create canvas for rotation
                        const canvas = document.createElement('canvas');
                        canvas.width = img.height;
                        canvas.height = img.width;
                        const ctx = canvas.getContext('2d');
                        
                        // Rotate image 90 degrees
                        ctx.translate(canvas.width/2, canvas.height/2);
                        ctx.rotate(90 * Math.PI/180);
                        ctx.drawImage(img, -img.width/2, -img.height/2);
                        
                        // Add to PDF
                        const imgData = canvas.toDataURL('image/jpeg', 0.9);
                        pdf.addImage(imgData, 'JPEG', 20, 20, pdf.internal.pageSize.width - 40, 0);
                        resolve();
                    } catch (error) {
                        console.error('Error processing image:', error);
                        resolve(); // Continue without image
                    }
                };
                
                img.onerror = () => {
                    console.warn('Failed to load image for PDF');
                    resolve(); // Continue without image
                };
                
                img.src = imageUrl;
            });
        }



        
        // // Initialize page
        // window.onload = function() {
        //     const data = getQueryParams();

        //     // Initially display Reporting Bot View
        //     document.getElementById('viewSelect').value = 'reporting-bot';
        //     updateReportingBotView();

        //     // Set ECG image in both views
        //     document.getElementById('patientImage').src = data.reportImage;
        //     document.getElementById('ecgImage').src = data.reportImage;
        //     initializeEventListeners();
        //     switchView();
        // };


    </script>
</body>
</html>